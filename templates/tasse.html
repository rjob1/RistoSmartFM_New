{% extends "base.html" %}

{# 
ğŸ“‘ NOTE ENTI.JSON
- File in: static/data/enti.json
- Ogni ente = { "nome","sito","telefono","email","note" }
- Controlla sintassi JSON (no virgole finali). Test: http://127.0.0.1:5000/static/data/enti.json
#}

{% block title %}RistoSmart FM / Tasse & Contributi{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">
  <h2 class="mb-4">ğŸ“‘ Tasse & Contributi</h2>

  <!-- Form inserimento ente -->
  <form id="form-ente" class="row g-3 mb-4">
    <!-- Nome ente con dropdown personalizzabile -->
    <div class="col-md-6">
      <label class="form-label">Nome ente *</label>
      <div class="input-group">
        <input type="text" id="ente-nome-input" class="form-control" placeholder="-- Digita o seleziona ente --" required>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu dropdown-menu-end" id="ente-nome-dropdown">
          <li><a class="dropdown-item" href="#" data-value="">-- Seleziona ente --</a></li>
          <!-- Popolato via JS -->
        </ul>
        <button type="button" id="ente-info" class="btn btn-outline-secondary ms-1"
                data-bs-toggle="tooltip" data-bs-placement="top" title="Seleziona un ente per info">
          â„¹ï¸
        </button>
      </div>
    </div>

    <!-- Campi dati ente -->
    <div class="col-md-6">
      <label class="form-label">Sito</label>
      <input type="text" id="ente-sito" class="form-control" placeholder="https://...">
    </div>
    <div class="col-md-6">
      <label class="form-label">Telefono</label>
      <input type="text" id="ente-telefono" class="form-control" placeholder="+39...">
    </div>
    <div class="col-md-6">
      <label class="form-label">Email *</label>
      <input type="email" id="ente-email" class="form-control" required placeholder="email@ente.it">
    </div>
    <div class="col-md-6">
      <label class="form-label">IBAN</label>
      <input type="text" id="ente-iban" class="form-control" placeholder="IT60X...">
    </div>
    <div class="col-md-6">
      <label class="form-label">BIC</label>
      <input type="text" id="ente-bic" class="form-control" placeholder="SWIFT/BIC">
    </div>

    <!-- Pulsanti allineati orizzontalmente -->
    <div class="col-12 d-flex justify-content-end gap-2 mt-2">
      <a href="/pagamento-tasse.html" class="btn btn-primary">Apri modulo di pagamento</a>
      <a href="/api/tasse/pdf" class="btn btn-outline-info">ğŸ“„ Scarica PDF</a>
      <button type="button" class="btn btn-success" id="btn-salva-ente">ğŸ’¾ Salva dati ente</button>
    </div>
  </form>

  <!-- Elenco enti registrati -->
  <h4 class="mb-3">ğŸ“‹ Enti registrati</h4>
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Nome ente *</th>
          <th>Sito</th>
          <th style="min-width: 140px; width: 140px;">Telefono</th>
          <th>Email *</th>
          <th>IBAN</th>
          <th>BIC</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="enti-body">
        <!-- righe generate via JS -->
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const entiKey = "ENTI_CACHE";

  // ğŸ”„ Render tabella enti
  function renderEnti(enti) {
    const body = document.getElementById("enti-body");
    body.innerHTML = "";
    enti.forEach((ente, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ente.nome}</td>
        <td>${ente.sito || ""}</td>
        <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${ente.telefono || ''}">
          ${ente.telefono || ""}
        </td>
        <td>${ente.email}</td>
        <td>${ente.iban || ""}</td>
        <td>${ente.bic || ""}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-warning btn-modifica" data-idx="${idx}">Modifica</button>
            <button class="btn btn-sm btn-danger btn-elimina" data-idx="${idx}">Elimina</button>
          </div>
        </td>`;
      body.appendChild(tr);
    });
  }

  // ğŸ”„ Carica elenco enti nazionali da enti.json
  async function loadEntiNazionali() {
    try {
      const res = await fetch("/static/data/enti.json");
      const data = await res.json();
      const dropdown = document.getElementById("ente-nome-dropdown");

      // Pulisci dropdown
      dropdown.innerHTML = '<li><a class="dropdown-item" href="#" data-value="">-- Seleziona ente --</a></li>';

      // Aggiungi ogni ente
      data.forEach(e => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.className = "dropdown-item";
        a.href = "#";
        a.dataset.value = e.nome;
        a.textContent = e.nome;
        a.dataset.sito = e.sito || "";
        a.dataset.telefono = e.telefono || "";
        a.dataset.email = e.email || "";
        a.dataset.note = e.note || "";
        li.appendChild(a);
        dropdown.appendChild(li);
      });

      // Gestisci selezione dal dropdown
      dropdown.addEventListener("click", e => {
        if (e.target.tagName === "A") {
          e.preventDefault();
          const nome = e.target.dataset.value;
          const sito = e.target.dataset.sito;
          const telefono = e.target.dataset.telefono;
          const email = e.target.dataset.email;
          const note = e.target.dataset.note;

          document.getElementById("ente-nome-input").value = nome;
          document.getElementById("ente-sito").value = sito;
          document.getElementById("ente-telefono").value = telefono;
          document.getElementById("ente-email").value = email;

          // Aggiorna tooltip â„¹ï¸
          const infoBtn = document.getElementById("ente-info");
          infoBtn.setAttribute("title", note || "Nessuna nota");
          const tooltip = bootstrap.Tooltip.getInstance(infoBtn);
          if (tooltip) tooltip.dispose();
          new bootstrap.Tooltip(infoBtn);
        }
      });

      // ğŸ” Cerca enti + crea nuovo se non trovato
      document.getElementById("ente-nome-input").addEventListener("input", () => {
        const val = document.getElementById("ente-nome-input").value.trim().toLowerCase();
        const items = document.querySelectorAll("#ente-nome-dropdown .dropdown-item");

        let found = false;
        items.forEach(item => {
          if (item.dataset.value && item.dataset.value.toLowerCase().includes(val)) {
            item.style.display = "block";
            found = true;
          } else if (!item.dataset.value) {
            item.style.display = "block"; // mantieni "-- Seleziona --"
          } else {
            item.style.display = "none";
          }
        });

        // Rimuovi opzioni "Crea" esistenti
        document.querySelectorAll("#ente-nome-dropdown .create-new").forEach(el => el.remove());

        if (!found && val) {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.className = "dropdown-item create-new";
          a.href = "#";
          a.dataset.value = val;
          a.textContent = `+ Crea "${val}"`;
          a.style.fontWeight = "bold";
          a.style.color = "#0d6efd";
          li.appendChild(a);
          document.getElementById("ente-nome-dropdown").appendChild(li);

          a.addEventListener("click", e => {
            e.preventDefault();
            document.getElementById("ente-nome-input").value = val;
            document.getElementById("ente-sito").value = "";
            document.getElementById("ente-telefono").value = "";
            document.getElementById("ente-email").value = "";
            document.getElementById("ente-iban").value = "";
            document.getElementById("ente-bic").value = "";
          });
        }
      });
    } catch (err) {
      console.error("Errore caricamento enti.json:", err);
    }
  }

  // ğŸ”„ Carica enti salvati nel DB
  async function loadEnti() {
    try {
      const res = await fetch("/api/enti");
      const data = await res.json();
      if (data.success) {
        localStorage.setItem(entiKey, JSON.stringify(data.enti));
        renderEnti(data.enti);
      } else {
        alert("Errore caricamento enti dal DB");
      }
    } catch (err) {
      console.error("Errore GET /api/enti:", err);
    }
  }

  // ğŸ’¾ Salva (nuovo o modifica)
  document.getElementById("btn-salva-ente").addEventListener("click", async () => {
    const payload = {
      nome: document.getElementById("ente-nome-input").value.trim(),
      sito: document.getElementById("ente-sito").value.trim(),
      telefono: document.getElementById("ente-telefono").value.trim(),
      email: document.getElementById("ente-email").value.trim(),
      iban: document.getElementById("ente-iban").value.trim(),
      bic: document.getElementById("ente-bic").value.trim()
    };
    if (!payload.nome || !payload.email) {
      alert("Nome ente ed Email sono obbligatori");
      return;
    }

    const editIdx = document.getElementById("form-ente").dataset.editIdx;
    const enti = JSON.parse(localStorage.getItem(entiKey) || "[]");

    if (editIdx !== undefined && editIdx !== "") {
      const ente = enti[editIdx];
      const res = await fetch(`/api/enti/${ente.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": window.CSRF_TOKEN },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.success) {
        alert("Errore update DB: " + (data.error || "sconosciuto"));
        return;
      }
      enti[editIdx] = { ...ente, ...payload };
      localStorage.setItem(entiKey, JSON.stringify(enti));
      document.getElementById("form-ente").dataset.editIdx = "";
    } else {
      const res = await fetch("/api/enti", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": window.CSRF_TOKEN },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.success) {
        alert("Errore insert DB: " + (data.error || "sconosciuto"));
        return;
      }
      enti.push({ ...payload, id: data.id });
      localStorage.setItem(entiKey, JSON.stringify(enti));
    }

    renderEnti(enti);
    document.getElementById("form-ente").reset();
  });

  // ğŸ—‘ï¸ Modifica/Elimina
  document.getElementById("enti-body").addEventListener("click", async e => {
    const enti = JSON.parse(localStorage.getItem(entiKey) || "[]");

    if (e.target.classList.contains("btn-elimina")) {
      const idx = e.target.dataset.idx;
      const ente = enti[idx];
      if (confirm("Vuoi davvero eliminare questo ente?")) {
        const res = await fetch(`/api/enti/${ente.id}`, {
          method: "DELETE",
          headers: { "X-CSRF-Token": window.CSRF_TOKEN }
        });
        const data = await res.json();
        if (!data.success) {
          alert("Errore delete DB: " + (data.error || "sconosciuto"));
          return;
        }
        enti.splice(idx, 1);
        localStorage.setItem(entiKey, JSON.stringify(enti));
        renderEnti(enti);
      }
    }

    if (e.target.classList.contains("btn-modifica")) {
      const idx = e.target.dataset.idx;
      const ente = enti[idx];
      document.getElementById("ente-nome-input").value = ente.nome;
      document.getElementById("ente-sito").value = ente.sito || "";
      document.getElementById("ente-telefono").value = ente.telefono || "";
      document.getElementById("ente-email").value = ente.email;
      document.getElementById("ente-iban").value = ente.iban || "";
      document.getElementById("ente-bic").value = ente.bic || "";
      document.getElementById("form-ente").dataset.editIdx = idx;
    }
  });

  // Abilita tooltips Bootstrap
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

  // ğŸš€ Prima ricarica
  await loadEntiNazionali();   // menu a tendina
  await loadEnti();            // tabella dal DB
});
</script>
{% endblock %}