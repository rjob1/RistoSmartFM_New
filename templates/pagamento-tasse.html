{% extends "base.html" %}

{% block title %}RistoSmart FM / Aggiungi Tassa{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
  <!-- Pulsante Scarica PDF -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">➕ Aggiunta Tassa</h2>
    <div class="dropdown">
      <button class="btn btn-outline-danger btn-sm dropdown-toggle" type="button" id="downloadPdfMenu" data-bs-toggle="dropdown" aria-expanded="false">
        📄 Scarica PDF
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="downloadPdfMenu">
        <li><a class="dropdown-item" href="#" onclick="scaricaPdfTasse(null, null)">📄 Tutte le tasse</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" onclick="scaricaPdfTasse(null, 'pagato')">🟢 Solo Pagate</a></li>
        <li><a class="dropdown-item" href="#" onclick="scaricaPdfTasse(null, 'non_pagato')">🔴 Non Pagate</a></li>
        <li><a class="dropdown-item" href="#" onclick="scaricaPdfTasse(null, 'standby')">🟡 In Standby</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" onclick="scaricaPdfTasseSelezione()">📋 Selezionate</a></li>
      </ul>
    </div>
  </div>  

  <!-- Notifiche -->
  <div id="notifiche" class="alert alert-info d-none mb-3"></div>

  <!-- Riga inserimento -->
  <div class="table-responsive mb-3">
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th style="width: 60px;"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
          <th style="min-width: 120px;">Data</th>
          <th style="min-width: 180px;">Ente</th>
          <th style="min-width: 180px;">Causale</th>
          <th style="min-width: 120px;">Scadenza</th>
          <th style="min-width: 100px;">Importo</th>
          <th style="min-width: 150px;">Stato</th>
          <th style="width: 220px;">Azioni</th>
        </tr>
      </thead>
      <tbody>
        <tr class="riga-inserimento">
          <td><input type="date" id="dataInserimento" class="form-control form-control-sm"></td>
          <td>
            <select id="enteId" class="form-select form-select-sm" required>
              <option value="">-- Seleziona un ente --</option>
              <!-- Popolato da JS -->
            </select>
          </td>
          <td><input type="text" id="causale" class="form-control form-control-sm" placeholder="Es. IVA Q3"></td>
          <td><input type="date" id="scadenza" class="form-control form-control-sm"></td>
          <td><input type="number" step="0.01" id="importo" class="form-control form-control-sm" placeholder="100.00"></td>
          <td>
            <select id="stato" class="form-select form-select-sm">
              <option value="non_pagato" selected>Non pagato</option>
              <option value="pagato">Pagato</option>
              <option value="standby">Standby</option>
            </select>
          </td>
          <td class="text-end">
            <button id="btnAggiungiTassa" class="btn btn-primary btn-sm">💾 Salva tassa</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Tabella tasse -->
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="tabellaTasse">
      <thead class="table-light">
        <tr>
          <th style="width: 60px;"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
          <th style="min-width: 120px;">Data</th>
          <th style="min-width: 180px;">Ente</th>
          <th style="min-width: 180px;">Causale</th>
          <th style="min-width: 120px;">Scadenza</th>
          <th style="min-width: 100px;">Importo</th>
          <th style="min-width: 150px;">Stato</th>
          <th style="width: 150px;">Azioni</th>
        </tr>
      </thead>

      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
  <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg">Salvato!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Popup QR -->
<div id="qr-popup" style="display: none; 
                           position: fixed; 
                           inset: 0; 
                           background: rgba(0,0,0,0.7); 
                           z-index: 99999 !important; 
                           justify-content: center; 
                           align-items: center; 
                           visibility: visible;">
  <div class="popup-content" style="background:white; 
                                     padding:20px; 
                                     border-radius:10px; 
                                     max-width:360px; 
                                     width:95%; 
                                     box-shadow:0 8px 18px rgba(0,0,0,0.3); 
                                     text-align:center;
                                     position: relative;">
    <img id="qr-image" src="" alt="QR Code SEPA" style="width:250px; border:1px solid #ddd; border-radius:8px;">
    <p id="qr-caption" class="mt-2 fw-bold">Caricamento...</p>
    <div class="text-start mt-2" style="font-size:0.85rem; color:#333;">
      <p><strong>Importo:</strong> <span id="qr-importo">-</span> €</p>
      <p><strong>IBAN:</strong> <span id="qr-iban">-</span></p>
      <p><strong>BIC:</strong> <span id="qr-bic">-</span></p>
      <p><strong>Causale:</strong> <span id="qr-causale">-</span></p>
    </div>
    <button type="button" id="btn-conferma-pagamento" class="btn btn-success mt-3 w-100">
      <i class="bi bi-check-circle me-1"></i> Conferma pagamento
    </button>
    <button type="button" class="btn btn-secondary mt-2 w-100" onclick="document.getElementById('qr-popup').style.display='none'">
      Chiudi
    </button>
  </div>
</div>

<!-- Popup Successo -->
<div id="qr-success" style="display: none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:10000; justify-content:center; align-items:center;">
  <div class="popup-content text-center" style="background:white; padding:20px; border-radius:10px; max-width:360px; width:95%; box-shadow:0 8px 18px rgba(0,0,0,0.3);">
    <p class="h5 mb-3">&#9989; Bonifico effettuato con successo</p>
    <button type="button" class="btn btn-primary btn-close-success">OK</button>
  </div>
</div>
{% endblock %}

<style>
@keyframes blink-10s { 0%, 90% { opacity: 1; } 91%, 100% { opacity: 0.6; } }
/* Riga inserimento */
.riga-inserimento .form-control, .riga-inserimento .form-select {
  font-size: 0.875rem; padding: 0.25rem 0.5rem; height: calc(1.5em + 0.75rem + 2px);
}
.riga-inserimento label { font-size: 0.8rem; font-weight: 500; margin-bottom: 0.2rem; color: #333; }
.riga-inserimento button { height: 100%; padding: 0.25rem 0.75rem; font-size: 0.85rem; }
.container-fluid { max-width: 1920px; margin: 0 auto; }
#tabellaTasse th, #tabellaTasse td { white-space: nowrap; vertical-align: middle; }
/* colonne larghezza minima */
#tabellaTasse th:nth-child(2), #tabellaTasse td:nth-child(2) { min-width: 200px; }
#tabellaTasse th:nth-child(3), #tabellaTasse td:nth-child(3) { min-width: 220px; }
#tabellaTasse th:nth-child(5), #tabellaTasse td:nth-child(5) { min-width: 100px; }
#tabellaTasse th:nth-child(6), #tabellaTasse td:nth-child(6) { min-width: 160px; }
#tabellaTasse th:nth-child(7), #tabellaTasse td:nth-child(7) { min-width: 120px; }
/* Popup QR */
#qr-popup .popup-content, #qr-success .popup-content {
  background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px;
  padding: 22px 20px; max-width: 360px; width: 95%; box-shadow: 0 8px 18px rgba(0,0,0,0.3);
  text-align: center;
}
#qr-popup img { width: 250px; border: 1px solid #ddd; border-radius: 8px; }
#qr-popup p, #qr-success p { margin: 0.3rem 0; font-size: 0.9rem; color: #1f2933; }
#qrCaption { font-weight: bold; font-size: 1rem; margin-top: 0.5rem; color: #005599; }
#qr-success .popup-content .h5 { color: #0f5132; font-weight: 600; margin-bottom: 1rem; }
#qr-success .btn-primary { font-weight: 600; padding: 0.6rem 1.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.25); }
/* Responsive */
@media (max-width: 576px) {
  #qr-popup .popup-content, #qr-success .popup-content { max-width: 95%; padding: 15px; }
  #qr-popup img { width: 200px; }
  #qr-popup p, #qr-success p { font-size: 0.8rem; }
  #qrCaption { font-size: 0.9rem; }
}
</style>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
#qr-success .popup-content {
  animation: fadeIn 0.3s ease-out;
}
</style>

{% block scripts %}
{% raw %}
<script>

// --- Funzioni PDF (prima di DOMContentLoaded) ---
function toggleAllCheckboxes(source) {
  const checkboxes = document.querySelectorAll('.tax-checkbox');
  checkboxes.forEach(cb => cb.checked = source.checked);
}

async function scaricaPdfTasse(ids = null, stato = null) {
  const payload = { ids, stato };
  try {
    const res = await window.csrfFetch('/api/pagamenti-tasse/pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.status === 404) {
      const errData = await res.json().catch(() => ({}));
      alert(errData.error || "❌ Nessuna tassa trovata per questa categoria.");
      return;
    }

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData.error || "Errore nel generare il PDF");
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tasse_${stato || 'tutte'}_${new Date().toISOString().slice(0,10)}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error("Errore scaricamento PDF:", err);
    alert("❌ Errore durante il download del PDF.");
  }
}

function scaricaPdfTasseSelezione() {
  const checked = document.querySelectorAll('.tax-checkbox:checked');
  const ids = Array.from(checked).map(cb => parseInt(cb.value));
  console.log("ID selezionati per PDF:", ids);  // ✅ aggiungi questa riga
  if (ids.length === 0) {
    alert("Seleziona almeno una tassa.");
    return;
  }
  scaricaPdfTasse(ids, null);
}


//--- Logica principale ---
document.addEventListener("DOMContentLoaded", async () => {
  const toast = new bootstrap.Toast(document.getElementById("toast"));
  let entiCache = [];
  const LS_KEY = 'RISTOSMART_TASSE';
  let tutteTasse = [];

  function salvaInLocale() {
    try { 
      localStorage.setItem(LS_KEY, JSON.stringify(tutteTasse)); 
    } catch (e) { 
      console.warn("Impossibile salvare in localStorage", e); 
    }
  }

  function caricaDaLocale() {
    try {
      const saved = localStorage.getItem(LS_KEY);
      if (saved) { 
        const localData = JSON.parse(saved); 
        return Array.isArray(localData) ? localData : []; 
      }
    } catch (e) { 
      console.error("Errore lettura localStorage", e); 
    }
    return null;
  }

  function normalizzaTassa(t) {
    if (!t) return null;
    const normalized = { ...t };
    normalized.stato = normalized.stato || "non_pagato";
    normalized.periodo = normalized.periodo || "";
    if (normalized.data_inserimento) normalized.data_inserimento = normalized.data_inserimento.substring(0, 10);
    if (normalized.scadenza) normalized.scadenza = normalized.scadenza.substring(0, 10);
    if (normalized.importo !== undefined && normalized.importo !== null && normalized.importo !== "") {
      const parsed = parseFloat(normalized.importo);
      normalized.importo = Number.isNaN(parsed) ? null : parsed;
    } else normalized.importo = null;
    normalized.ente_nome = (normalized.ente_nome || "Sconosciuto").trim();
    return normalized;
  }

  function mostraNotifiche(tasse) {
    const notificheDiv = document.getElementById("notifiche");
    const oggi = new Date();

    const inScadenza = tasse.filter(t => {
      const scad = new Date(t.scadenza);
      const giorni = Math.ceil((scad - oggi) / (1000 * 60 * 60 * 24));
      return t.stato === "non_pagato" && giorni <= 10 && giorni >= 0;
    });

    if (inScadenza.length === 0) {
      notificheDiv.className = "alert alert-success";
      notificheDiv.textContent = "Perfetto! Non hai tasse in scadenza.";
    } else {
      notificheDiv.className = "alert alert-warning";
      notificheDiv.innerHTML = `
        <strong>Attenzione!</strong> Hai ${inScadenza.length} tassa(e) in scadenza:
        <ul>${inScadenza.map(t =>
          `<li><strong>${t.ente_nome || "Senza ente"}</strong>: €${parseFloat(t.importo).toFixed(2)} 
          (scade il ${new Date(t.scadenza).toLocaleDateString()})</li>`
        ).join("")}</ul>
      `;
    }
    notificheDiv.classList.remove("d-none");
  }

  function aggiornaColoriRiga(tr, t) {
    const today = new Date();
    const scadenza = t.scadenza ? new Date(t.scadenza) : null;
    const diffDays = scadenza ? Math.ceil((scadenza - today) / (1000 * 60 * 60 * 24)) : null;

    tr.querySelectorAll("input,select").forEach(el => {
      el.style.color = "#000";
      el.style.fontWeight = "normal";
      el.style.animation = "none";
    });

    if (t.stato === "pagato") {
      tr.querySelectorAll("input,select").forEach(el => {
        el.style.color = "#00aa00";  // verde
        el.style.fontWeight = "bold";
      });
    } else if (t.stato === "non_pagato" && diffDays !== null && diffDays <= 10 && diffDays >= 0) {
      tr.querySelectorAll("input,select").forEach(el => {
        el.style.color = "#cc0000";  // rosso
        el.style.fontWeight = "bold";
        el.style.animation = "blink-10s 10s infinite";
      });
    } else if (t.stato === "standby") {
      tr.querySelectorAll("input,select").forEach(el => {
        el.style.color = "#e6b800";  // giallo
        el.style.fontWeight = "bold";
      });
    }
  }

  function aggiornaBottonePagamento(tr, stato) {
    const pagaBtn = tr.querySelector(".btn-paga"); 
    if (!pagaBtn) return;
    const statoCorrente = stato || tr.dataset.stato || "non_pagato";
    if (statoCorrente === "pagato") { 
      pagaBtn.disabled = true; 
      pagaBtn.innerHTML = '<i class="bi bi-check2-circle"></i> Pagato'; 
      pagaBtn.classList.remove("btn-outline-success"); 
      pagaBtn.classList.add("btn-secondary"); 
    } else { 
      pagaBtn.disabled = false; 
      pagaBtn.innerHTML = '<i class="bi bi-credit-card"></i> Paga'; 
      pagaBtn.classList.remove("btn-secondary"); 
      pagaBtn.classList.add("btn-outline-success"); 
    }
  }

  async function caricaEnti() {
    try {
      const res = await fetch("/api/enti");
      const data = await res.json();
      if (!data.success) throw new Error(data.error);

      entiCache = data.enti;
      const select = document.getElementById("enteId");

      // Svuota prima
      select.innerHTML = '<option value="">-- Seleziona un ente --</option>';

      // Aggiungi ogni ente
      entiCache.forEach(ente => {
        const opt = document.createElement("option");
        opt.value = ente.id;  // ✅ ID numerico
        opt.textContent = `${ente.nome} ${ente.iban ? `(IBAN: ${ente.iban})` : ""}`;
        select.appendChild(opt);
      });
    }
    catch (err) {
      console.error("Errore caricamento enti:", err);
      alert("❌ Errore caricamento enti: " + err.message);
    }
  }

  // --- Funzione aggiungiRiga ---
  function aggiungiRiga(t) {
    const tbody = document.querySelector("#tabellaTasse tbody");
    const tr = document.createElement("tr");

    // Dropdown stati
    const stati = ["non_pagato", "pagato", "standby"];
    let statoOpt = "";
    stati.forEach(s => {
      const label = s === "non_pagato" ? "Non pagato" : 
                    s === "pagato" ? "Pagato" : "Standby";
      statoOpt += `<option value="${s}" ${s === t.stato ? "selected" : ""}>${label}</option>`;
    });

    // Bottone Paga
    let btnPagaHtml;
    if (t.stato === "pagato") {
      btnPagaHtml = `<button class="btn btn-secondary btn-sm btn-paga" disabled>
                      <i class="bi bi-check2-circle"></i> Pagato
                    </button>`;
    } else {
      btnPagaHtml = `<button class="btn btn-outline-success btn-sm btn-paga">
                      <i class="bi bi-credit-card"></i> Paga
                    </button>`;
    }

    tr.innerHTML = `
      <td><input type="checkbox" class="form-check-input tax-checkbox" value="${t.id}"></td>
      <td><input type="date" class="form-control form-control-sm data-input bg-white" value="${t.data_inserimento || ''}" disabled></td>
      <td>
        <select class="form-select form-select-sm ente-input bg-white" disabled>
          <option value="">-- Seleziona --</option>
          ${entiCache.map(e => `
            <option value="${e.id}" ${e.id == t.ente_id ? 'selected' : ''}>
              ${e.nome} ${e.iban ? `(IBAN: ${e.iban})` : ""}
            </option>
          `).join("")}
        </select>
      </td>
      <td><input type="text" class="form-control form-control-sm causale-input bg-white" value="${t.causale || ''}" disabled></td>
      <td><input type="date" class="form-control form-control-sm scadenza-input bg-white" value="${t.scadenza || ''}" disabled></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm importo-input bg-white" value="${t.importo ? t.importo.toFixed(2) : ''}" disabled></td>
      <td><select class="form-select form-select-sm stato-input bg-white" disabled>${statoOpt}</select></td>
      <td class="text-end">
        <div class="d-flex justify-content-end gap-1">
          <button class="btn btn-outline-primary btn-sm btn-edit"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-outline-success btn-sm btn-save d-none"><i class="bi bi-save"></i></button>
          ${btnPagaHtml}
          <button class="btn btn-outline-danger btn-sm btn-elimina"><i class="bi bi-trash"></i></button>
        </div>
      </td>
    `;

    tr.dataset.id = t.id;
    aggiornaColoriRiga(tr, t);

    // ✅ Eventi devono essere dentro la funzione
    tr.querySelector(".btn-edit").addEventListener("click", () => {
      tr.querySelectorAll("input,select").forEach(el => el.disabled = false);
      tr.querySelector(".btn-edit").classList.add("d-none");
      tr.querySelector(".btn-save").classList.remove("d-none");
    });

    tr.querySelector(".btn-save").addEventListener("click", async () => {
      const enteIdInput = tr.querySelector(".ente-input");
      const nuovoEnteId = parseInt(enteIdInput.value);
      if (isNaN(nuovoEnteId)) {
        alert("Seleziona un ente valido.");
        return;
      }
      
      const nuovo = {
        data_inserimento: tr.querySelector(".data-input").value,
        ente_id: nuovoEnteId,
        causale: tr.querySelector(".causale-input").value,
        scadenza: tr.querySelector(".scadenza-input").value,
        importo: parseFloat(tr.querySelector(".importo-input").value || 0),
        stato: tr.querySelector(".stato-input").value
      };

      try {
        const res = await window.csrfFetch(`/api/tasse/${t.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuovo)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Errore salvataggio");

        Object.assign(t, nuovo);
        aggiornaColoriRiga(tr, t);

        tr.querySelectorAll("input,select").forEach(el => el.disabled = true);
        tr.querySelector(".btn-edit").classList.remove("d-none");
        tr.querySelector(".btn-save").classList.add("d-none");

        mostraToast("✅ Tassa aggiornata");
        salvaInLocale();
        mostraNotifiche(tutteTasse);
      } catch (err) {
        alert("Errore: " + err.message);
      }
    });

    tr.querySelector(".btn-paga").addEventListener("click", () => apriPopupQR(t));

    tr.querySelector(".btn-elimina").addEventListener("click", async () => {
      if (!confirm(`Sei sicuro di voler eliminare la tassa per ${t.ente_nome}?`)) return;
      
      try {
        const res = await window.csrfFetch(`/api/tasse/${t.id}`, { method: "DELETE" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Errore eliminazione");

        tr.remove();
        tutteTasse = tutteTasse.filter(item => item.id !== t.id);
        salvaInLocale();
        mostraToast("🗑️ Tassa eliminata");
        mostraNotifiche(tutteTasse);
      } catch (err) {
        alert("Errore: " + err.message);
      }
    });

    tbody.appendChild(tr);
  }

  async function eliminaTassa(t, tr) {
    if (!confirm(`Sei sicuro di voler eliminare la tassa per ${t.ente_nome}?`)) return;

    try {
      const res = await window.csrfFetch(`/api/tasse/${t.id}`, {
        method: "DELETE"
      });
      const data = await res.json();

      if (!data.success) throw new Error(data.error || "Errore durante l'eliminazione");

      // Rimuovi dalla UI
      tr.remove();
      // Rimuovi da array locale
      tutteTasse = tutteTasse.filter(item => item.id !== t.id);
      salvaInLocale();
      mostraToast("🗑️ Tassa eliminata");
    } catch (err) {
      console.error("Errore eliminazione tassa:", err);
      alert("❌ Errore: " + err.message);
    }
  }

  function modificaTassa(t, tr) {
    alert("Funzione Modifica non ancora implementata.\nID: " + t.id + "\nCausale: " + t.causale);
  }

  // --- Gestione salvataggio nuova tassa ---
  function mostraToast(messaggio) {
    const toastEl = document.getElementById("toast");
    document.getElementById("toastMsg").textContent = messaggio;
    const bsToast = new bootstrap.Toast(toastEl);
    bsToast.show();
  }

  // ✅ FUNZIONE SPOSTATA QUI DENTRO: ora vede aggiungiRiga, mostraToast, etc.
  async function apriPopupQR(t) {
    console.log("🔍 apriPopupQR chiamata con:", t);

    if (!t || !t.id) {
      console.error("❌ Oggetto tassa mancante o ID non valido");
      alert("Errore: impossibile aprire il QR. Dati tassa non validi.");
      return;
    }

    try {
      console.log(`📡 Richiesta GET /api/tasse/${t.id}/qr in corso...`);
      
      const res = await fetch(`/api/tasse/${t.id}/qr`);
      
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || `Errore HTTP ${res.status}`);
      }

      console.log("✅ Risposta ricevuta dal server");
      const data = await res.json();
      console.log("📊 Dati QR ricevuti:", data);

      if (!data.qr_image) {
        throw new Error("Dato QR mancante: qr_image non presente nella risposta");
      }

      document.getElementById("qr-image").src = data.qr_image;
      document.getElementById("qr-caption").textContent = `Tassa: ${data.ente || "Sconosciuto"}`;
      document.getElementById("qr-importo").textContent = data.importo || "-";
      document.getElementById("qr-iban").textContent = data.iban || "-";
      document.getElementById("qr-bic").textContent = data.bic || "-";
      document.getElementById("qr-causale").textContent = data.causale || "-";

      const popup = document.getElementById("qr-popup");
      if (!popup) {
        throw new Error("Popup QR non trovato nel DOM");
      }

      popup.style.display = "flex";
      console.log("🎉 Popup QR mostrato con successo");

      const btnConferma = document.getElementById("btn-conferma-pagamento");
      if (!btnConferma) {
        console.warn("⚠️ Bottone conferma pagamento non trovato");
        return;
      }

      const nuovoBtn = btnConferma.cloneNode(true);
      btnConferma.replaceWith(nuovoBtn);

      nuovoBtn.onclick = async () => {
        console.log("💳 Conferma pagamento cliccata");
        try {
          const payRes = await window.csrfFetch(`/api/tasse/${t.id}/paga`, { method: "POST" });
          const payData = await payRes.json();
          
          if (!payRes.ok) throw new Error(payData.error || "Errore pagamento");

          console.log("✅ Pagamento confermato sul server");

          t.stato = "pagato";          

          // ✅ Aggiorna l'array principale (tutteTasse)
          const idx = tutteTasse.findIndex(item => item.id === t.id);
          if (idx !== -1) {
            tutteTasse[idx].stato = "pagato";
          }

          // ✅ Salva in localStorage
          salvaInLocale();

          aggiungiRiga(t);
          const oldTr = document.querySelector(`#tabellaTasse tbody tr[data-id="${t.id}"]`);
          if (oldTr) oldTr.remove();

          mostraToast("✅ Pagamento confermato");

          // ✅ CALCOLA IN QUALE MESE DEVE ESSERE REGISTRATA LA SPESA
          const meseScadenza = t.scadenza || t.data_inserimento;
          const [anno, mese] = meseScadenza.split('-'); // es. "2025-01-15" → ["2025", "01"]
          const nomeMese = ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno",
                            "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"][parseInt(mese)-1];

          // ✅ ID DEL CAMPO NEL MESE.HTML (es. #agenzia_entrata)
          const idSpesa = t.ente_id?.toString(); 
          const mappaEnti = {
            "1": "agenzia_entrata",     // Agenzia delle Entrate
            "2": "inps",                // INPS
            "3": "inail",               // INAIL
            "4": "camera_commercio",    // Camera di Commercio
            "5": "siae",                // SIAE
            "6": "adm",                 // ADM
            "7": "asl",                 // ASL
            "8": "comune"               // Comune
          };
          const campoId = mappaEnti[idSpesa] || null;

          if (!campoId) {
            console.warn("Nessun campo associato per l'ente ID:", idSpesa);
          } else {
            // ✅ INVIA DATO A MESE.HTML ATTRAVERSO localStorage + EVENTO
            try {
              const payload = {
                tipo: "tassa_pagata",
                anno: anno,
                mese: nomeMese,
                campo: campoId,
                importo: parseFloat(t.importo),
                timestamp: Date.now()
              };

              // Invia segnale a mese.html
              localStorage.removeItem('trigger_mese_update');
              localStorage.setItem('trigger_mese_update', JSON.stringify(payload));
              setTimeout(() => localStorage.removeItem('trigger_mese_update'), 100);

              console.log("[tasse] Trigger inviato a mese.html:", payload);
            } catch (e) {
              console.warn("Impossibile inviare aggiornamento a mese.html", e);
            }
          }
          
          popup.style.display = "none";
          
          // Mostra popup successo
          document.getElementById("qr-success").style.display = "flex";

          // Chiudi con bottone OK
          const closeSuccessBtn = document.querySelector("#qr-success .btn-close-success");
          if (closeSuccessBtn) {
            // Rimuovi listener duplicati
            const clonedBtn = closeSuccessBtn.cloneNode(true);
            closeSuccessBtn.replaceWith(clonedBtn);

            clonedBtn.addEventListener("click", () => {
              document.getElementById("qr-success").style.display = "none";
            });
          }
        } catch (err) {
          console.error("❌ Errore durante conferma pagamento:", err);
          alert("❌ Errore: " + err.message);
        }
      };

    } catch (err) {
      console.error("❌ Errore caricamento QR:", err);
      alert("❌ Impossibile caricare il QR Code: " + (err.message || "Errore sconosciuto"));
    }
  }

  // --- Caricamento iniziale ---  
  await caricaEnti();
  document.getElementById("dataInserimento").value = new Date().toISOString().split('T')[0];

  const localData = caricaDaLocale();
  if (localData && localData.length > 0) {
    tutteTasse = localData.map(normalizzaTassa).filter(Boolean);
  } else {
    try {
      const res = await fetch("/api/tasse");
      const data = await res.json();
      if (data.success) {
        tutteTasse = (data.tasse || []).map(normalizzaTassa).filter(Boolean);
        salvaInLocale();
      }
    } catch (e) {
      console.error("Errore caricamento tasse:", e);
    }
  }

  tutteTasse.forEach(t => aggiungiRiga(t));
  mostraNotifiche(tutteTasse);

  // --- Gestione salvataggio nuova tassa ---
  document.getElementById("btnAggiungiTassa").addEventListener("click", () => {
    const dataInserimento = document.getElementById("dataInserimento").value;
    const enteId = parseInt(document.getElementById("enteId").value);
    if (isNaN(enteId)) {
      alert("Seleziona un ente valido.");
      return;
    }
    const causale = document.getElementById("causale").value.trim();
    const scadenza = document.getElementById("scadenza").value;
    const importo = document.getElementById("importo").value;
    const stato = document.getElementById("stato").value;

    if (!dataInserimento || !enteId || !scadenza || !importo) {
      alert("Compila tutti i campi obbligatori.");
      return;
    }

    const importoNum = parseFloat(importo);
    if (isNaN(importoNum) || importoNum <= 0) {
      alert("Importo non valido.");
      return;
    }

    const nuovaTassa = {
      data_inserimento: dataInserimento,
      ente_id: enteId,
      causale,
      scadenza,
      importo: importoNum,
      stato
    };

    window.csrfFetch("/api/tasse", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(nuovaTassa)
    })
    .then(async (res) => {
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || `Errore HTTP ${res.status}`);
      }
      return await res.json();
    })
    .then((data) => {
      const selectedOption = document.getElementById("enteId").selectedOptions[0];
      const enteNome = selectedOption ? selectedOption.text.split(" (")[0] : "Sconosciuto";

      const tassaCompleta = {
        ...nuovaTassa,
        id: data.id,
        ente_nome: enteNome
      };
      tutteTasse.push(tassaCompleta);
      salvaInLocale();
      aggiungiRiga(tassaCompleta);
      mostraToast("✅ Tassa salvata!");

      document.getElementById("causale").value = "";
      document.getElementById("importo").value = "";
      document.getElementById("scadenza").value = "";
      document.getElementById("stato").selectedIndex = 0;
    })
    .catch(err => {
      console.error("Errore salvataggio tassa:", err);
      alert("❌ Errore: " + (err.message || "Salvataggio fallito"));
    });
  });
});

// --- Auto-refresh da altri tab ---
window.addEventListener('storage', function(event) {
  if (['trigger_taxes_refresh', 'trigger_mese_update', 'trigger_annual_refresh'].includes(event.key)) {
    location.reload();
  }
});
</script>
{% endraw %}
{% endblock %}